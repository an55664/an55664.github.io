<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine Tokens</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
</head>
<body>
    <h1>Mine Tokens</h1>
    <label for="address">Your Ethereum Address:</label><br>
    <input type="text" id="address" name="address"><br><br>
    <button onclick="mineTokens()">Mine</button>
    <button onclick="startAutoMining()">Start Auto Mining</button> <!-- 添加开始自动挖矿按钮 -->
    <button onclick="stopAutoMining()">Stop Auto Mining</button> <!-- 添加停止自动挖矿按钮 -->

    <p id="hashRate">Mining Hash Rate: -</p> <!-- Add an element to display hash rate -->

    <script>
        let miningInterval; // 保存挖矿定时器

        async function getHashRate() {
            // 替换为你的挖矿合约地址
            const miningContractAddress = '0xe8fB5a79F590ECC4af73a79188b1352f9A8Ca8a6';

            // 挖矿合约 ABI
            const miningContractABI = [
                // 合约 ABI 略
            ];

            // 实例化挖矿合约
            const web3 = new Web3(window.ethereum); // 连接到用户的 MetaMask 或其他钱包
            const miningContractInstance = new web3.eth.Contract(miningContractABI, miningContractAddress);

            // 获取挖矿统计信息
            const blockNumber = await web3.eth.getBlockNumber();
            const blockStart = blockNumber - 10; // 获取10个区块之前的区块号
            const blockEnd = blockNumber;

            let totalHashes = 0;
            for (let i = blockStart; i <= blockEnd; i++) {
                const block = await web3.eth.getBlock(i);
                totalHashes += block.hash.length; // 以哈希长度作为哈希率的粗略估计
            }

            const avgHashRate = totalHashes / (blockEnd - blockStart + 1);
            document.getElementById('hashRate').innerText = 'Mining Hash Rate: ' + avgHashRate.toFixed(2) + ' hashes/s';
        }

        async function mineTokens() {
            // 获取用户的以太坊地址
            const userAddress = document.getElementById('address').value.trim();
            if (!userAddress) {
                alert('Please enter your Ethereum address');
                return;
            }

            // 替换为你的挖矿合约地址
            const miningContractAddress = '0xe8fB5a79F590ECC4af73a79188b1352f9A8Ca8a6';

            // 挖矿合约 ABI
            const miningContractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_totalSupplyLimit",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_miningReward",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_miningDifficulty",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "_owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "_spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			}
		],
		"name": "mine",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "mint",
		"outputs": [
			{
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "_to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "Mint",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "_from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "_to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "balance",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "miningDifficulty",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "miningReward",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupplyLimit",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

            // 实例化挖矿合约
            const web3 = new Web3(window.ethereum); // 连接到用户的 MetaMask 或其他钱包
            const miningContractInstance = new web3.eth.Contract(miningContractABI, miningContractAddress);

            // 生成一个随机 nonce
            const nonce = Math.floor(Math.random() * 1000000); // 调整范围以适合需要

            // 调用带有 nonce 参数的 mine 函数
            miningContractInstance.methods.mine(nonce).send({ from: userAddress })
            .then(function(receipt){
                console.log("Mining successful");
                // 挖矿后更新哈希率
                getHashRate();
            })
            .catch(function(error){
                console.error("Mining failed: " + error);
            });
        }

        // 开始自动挖矿
        function startAutoMining() {
            miningInterval = setInterval(mineTokens, 5000); // 每5秒执行一次挖矿
        }

        // 停止自动挖矿
        function stopAutoMining() {
            clearInterval(miningInterval); // 停止挖矿定时器
        }
    </script>
</body>
</html>
